
# UT Azure (仮) クレジット運用シミュレータ

## これは何?

1. UT Azure (仮) のクレジット運用に必要な計算を行う
1. テキストでの出力およびグラフィックによる可視化で, 運用規則に関する理解を深める
1. 様々なパラメータでのシミュレーションを行って想定されるリスクの評価などを行う

## 使う準備

* Pythonがインストールされていなければして下さい
* 以下のPythonモジュールをインストール

```
$ pip install matplotlib
```
* `matplotlib` がインストールできない場合は `--plots none` オプションをつけるとグラフの可視化をせずにシミュレーションをすることができます

## クレジット運用に必要な計算を行う使い方

* 最低限の内容として以下のようなCSVファイル(`minimum_script.csv`)を用意して(作る場合はExcel, Google Spreadsheetやテキストエディタで)
```
python azsim.py --script minimum_script.csv
```
として実行, うまくすると`hist.csv`というファイルが出力され, グラフが表示される

  |A|B|C|D|E|F|
  |--|--|--|--|--|--|
  ||C0|150000000||||
  ||n_budget_periods|10||||
  |S00000|used|3701955.06|4001194.82|2358717.06|1269380.56|847837.59|
  |S00001|used|7948166.85|863160.93|2176748.03|499632.54|1249000.33|
  |S00002|used|3103044.9|4402096.55|15533051.76|1875239.66|3134601.56|
  |S00003|used|3665048.91|6125364.08|1126485.98|5381308.51|2194964.21|
  |S00004|used|732204.84|8490756.97|2567486.29|469366.97|10283292.9|

### 入力ファイル `minimum_script.csv` 解説
  * A列のS0000, ..., S00009 はサブスクリプション名(任意の文字列)
    * つまりこのファイルで10個のサブスクリプションがある状態のシミュレーションを行う
  * B列は属性名
    * A列が空でない --- サブスクリプション名が書いてある --- 行 (5-14行) は, そのサブスクリプションの属性
      * `used` : そのサブスクリプションの各期の使用量
    * A列が空の行 (1-4行) は全体のパラメータ設定
      * `C0` : クレジット初期値 (e.g., 15億とか); 単なる数字なのでUSDなのかJPYなのかなどは気にしません(ご自由)
      * `n_budget_periods` : C0を使い切る予定の期の数 (e.g., 60とか); おそらく期=月という運用になりますがこれも期が何であるかには無関係
  * C列以降はその属性の値
    * 値が全期間を通じて変わらない(一つだけの)場合と, 期ごとの値を並べる場合がある
* 注
  * 列の使い方に賢さはないので, 左端に自分の好きな列を追加するなどはできません(ヘッダ行とか入れて, できるようにしてあげればいいのか...)
  * B列の属性名に, 認識されないものを書くと単に無視されます
    * なので適当な名前に変えると無視される(コメントアウトの効果を持つ)などの柔軟性ができますが
    * 一方, 正しい名前のつもりで書いたものが無視されるので, スペルミスには注意して下さい

### 出力ファイル `hist.csv` 解説

* 入力ファイルに様々な計算結果が付け加わったもの
* 全体の値
  * `C0, n_budget_periods`,  : 入力と同じ意味
  * `T` : (時系列値) 各期終わり時点での目安クレジット残量
  * `C` : (時系列値) 各期終わり時点での実際のクレジット残量
  * `F0` : (時系列値) 各期の, 無料($F_0$)枠
  * `k0` : (時系列値) 各期で, $F_0$枠の分配時に求めた$k$の値 (各サブスク$k w$以下は無料という閾値)
  * `F1` : (時系列値) 各精算期の, 割引($F_1$)枠
  * `k1` : (時系列値) 各期で, $F_1$枠の分配時に求めた$k$の値 (各サブスク$k w$以下まで割引という閾値)

  * その他 : 計算の際に指定可能なで, 実際に使われた値が書いてあるがここでは関係ないので後述
* 各サブスクの値
  * `weight` : 各期における重み
  * `S` : 各期におけるそのサブスクの安全値 (S値); $F_0$を重みによって配分した値
  * `used` : 各期において使用したクレジット量 (入力と同じ). 無料になったか否かによらずすべて
  * `free` : 各期において免除された(無料になった)クレジット量
  * `pend` : 超過クレジットでまだ払っていない値の累積 (精算するまで持ち越されていく)
  * `disc` : 精算期に割引されたクレジット量
  * `paid` : 精算期に実際に支払うことになったレジット量

### 表示されるグラフについて
* "remaining credit" 
  * 青: 目安残量; `C0` が `n_budget_periods`で 消費されるように計画されたクレジットの残量
  * 橙: 実際の残量
* 残りはサブスクリプションのグラフで, デフォルトは最初の2つのサブスク
  * 黒線 (used) : 各期の使用量
  * 黄線 (S) : 各期の$S$値
  * 青棒 (free) : 各期の無料枠
  * 橙棒 (pend) : 各期で残った超過分(前期からの持ち越し分含む)
  * 緑棒 (disc) : 精算期に残った超過分の中で, 割引(支払い免除)された分
  * 赤棒 (paid) : 精算期に残った超過分の中で, 実際に払った(免除されなかった)された分

### テキスト出力

* テキストの出力を読むと計算の過程なども理解できるように書かれているつもり

### 典型利用場面1: $F$値, $S$値の計算

運用に当たり, 現在までの各サブスクのクレジット使用量と期ごとの目安残量に基づき, 以下の$F_0$値, $S$値を計算してアナウンスする必要がある

* その期で使える無料枠は大学全体としてどれだけか($F_0$値; 大学全体で一つ)
* その期で各サブスクが「安全に」使えるクレジット値はどれだけか($S$値; 各サブスクごとの値)
  * $S$値 : そのサブスクが$S$値以下しか使わなければ(他のサブスクがいくら使っても)無料枠に収まる(「安全」), という値
  * 注: 他のサブスクで$S$値以下しか使わなかったものがあれば, $S$値を越えても結果的に無料枠に収まることは有りうる
    * あくまで無料になるかどうかは期の終わりに全サブスクを合計して$F_0$に収まるかどうかで判定される
  * $S$値は, 各サブスクの重みによって決まる. 重みが同じなら同じになる. 

$F_0$値, $S$値を計算する機能は `azsim.py`ツールの出力(`hist.csv`)に自然に含まれている

具体的には, $t$期の$F_0$値や$S$値を計算したければ, $(t-1)$期までの使用量が埋まったデータを用意して, $t$期までのシミュレーションを行えば良い. そして$F_0$や$S$の行, $t$期の列, の値を見れば良い. $t$期の使用量データは空欄で, 0とみなして$t$期の計算を行うが, $F_0$, $S$の値は使用量には寄らないので問題ない

例:
* `minimum_script.csv`は5期までの使用量データが埋まっている
* この状態で6期までのシミュレーションを行えば, 6期の$F$値や$S$値が求まる
* 期は1から数えることに注意($t=1$が一番最初の期)

```
python azsim.py --script-csv minimum_script.csv --end-t 6
```

### 典型利用場面2: 超過クレジット・支払い額の計算

徴収額が最終的に決まるまでの過程は以下

* 各期の終わりに, 各サブスクの使用量を反映した, 実際の無料枠($k_0$値)を計算
  * 重みが$w$のサブスクは, $k_0w$までが無料になる
* 各サブスクの, $k_0w$を越えた使用量(*暫定超過クレジット* = 課金される可能性の有るクレジット)を計算
* 暫定超過クレジットは, 何期かに一度訪れる精算のタイミング(e.g., 9月と3月)までは, 次期に先送りが可能で, 次期の利用が$k_0 w$より少なければその余りで一部または全部相殺される
* 支払い精算のタイミングまで相殺されずに残っていた暫定超過クレジットに対して, 実際に支払い額が算出される
  * 実際の支払額は, その額面額通り(正規料金)となるわけではなく, そのサブスクの超過確定クレジットの累計が小さいうちは安め, 大きくなるにつれて高くなり, 有る一定値を超えると正規料金になる
* 詳細な計算方法はスライド 2024/09/10 [MS Azure]クレジットの運用方針 ver. 0.85 を参照

これらの値も`azsim.py`の出力(`hist.csv`)に自然に含まれている

* `free` : 各期の, 無料になったクレジット
* `pend` : 各期の, 無料枠を超過したクレジット(前期からの持ち越し分含む)
* `disc` : 精算期まで持ち越されたクレジットのうち割引されたクレジット量
* `paid` : 精算期まで持ち越されたクレジットのうち実際に支払った

例えば第6期 (おそらく2025/03) 末における支払額を計算したければ, 6期までの使用量が記入された csv ファイル (`minimum_script_6.csv`) を準備して

```
python azsim.py --script-csv minimum_script_6.csv
```

とすればよい

## ファイルなしでシミュレーション

* 様々な状況の観察をするためにファイルではなく乱数を使ったシミュレーションが可能
* `--script` オプションなしで実行するとこのモードになる

```
python azsim.py 
```

## オプション

* `--script SCRIPT.CSV`   simulate this CSV file
* `--hist HIST.CSV` write results to this CSV file
* `--C0` $C_0$ : 初期クレジット量を$C_0$にする (デフォルト: 1500000000 or 1.5e8)
* `--n-budget-periods` $P$ : 予算が有効な期間数. $P$期で$C_0$を使い切るのが目標
* `--period` $T_0,T_1,T_2,...` :
* `--start-t T`
* `--end-t T`
* `--settle-period T0,T1,T2,...`
* `--settle-interval dT`
* `--init-subscs N`
* `--mean-delta-subscs N`
* `--weight-change-prob P`
* `--user-algo ALGO`
* `--mean-use-factor F`
* `--random-use 0/1`
* `--seed S`
* `--dbg LEVEL`
* `--plots S0,S1,...`

## 15億, 1000サブスク, 60期のシミュレーション


## 改善予定項目

* 入力を業務に適した形に
  * Azureのサブスクの利用量のExcelを直接読み取る
  * ??
* 出力を業務に適した形に
  * 全体へのアナウンス : $F_0$, サブスク数, 各サブスクの$S$値, etc.
  * 各サブスクごとの請求書的なもの(各期の使用量, 無料枠, 精算期まで残った超過量, それに対する支払いをExcelおよびグラフで)

